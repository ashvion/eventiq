<!-- Floating Action Button -->
<button id="chat-fab" class="chat-fab" aria-label="Open Chat">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
</button>

<!-- Chat Window -->
<div id="chat-widget" class="chat-widget">
    <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span>ðŸ¤–</span>
            <span style="font-weight: 600;">EventIQ Assist</span>
        </div>
        <button id="close-chat" style="background: none; border: none; color: white; cursor: pointer;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <div id="widget-history" class="chat-body">
        <div class="chat-msg bot">
            <div class="msg-bubble">
                Hello! I can help you find events, plan budgets, or answer questions. How can I assist?
            </div>
        </div>
    </div>

    <div class="chat-footer">
        <form id="widget-form" style="display: flex; gap: 0.5rem;">
            <input type="text" id="widget-input" placeholder="Ask me anything..." required>
            <button type="submit" class="btn-send">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>
    </div>
</div>

<style>
    /* Bulletproof Dark Theme for Chat Widget */
    :root {
        --chat-bg: #0f0f0f;
        --chat-body-bg: #050505;
        --chat-accent: #4f46e5;
        --chat-user-msg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        --chat-bot-msg: rgba(255, 255, 255, 0.05);
        --chat-border: rgba(255, 255, 255, 0.1);
        --chat-text: #ffffff;
        --chat-text-muted: rgba(255, 255, 255, 0.6);
    }

    .chat-widget {
        position: fixed;
        bottom: 6rem;
        right: 2rem;
        width: 350px;
        height: 500px;
        background: var(--chat-bg) !important;
        border-radius: 20px !important;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5) !important;
        z-index: 9999 !important;
        display: none;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid var(--chat-border) !important;
        backdrop-filter: blur(20px);
        font-family: 'Outfit', sans-serif;
    }

    .chat-widget.active {
        display: flex !important;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--chat-accent) 0%, #6366f1 100%) !important;
        color: white !important;
        padding: 1.25rem !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-body {
        flex-grow: 1;
        padding: 1.25rem !important;
        overflow-y: auto;
        background: var(--chat-body-bg) !important;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-footer {
        padding: 1.25rem !important;
        background: var(--chat-bg) !important;
        border-top: 1px solid var(--chat-border) !important;
        display: flex;
        gap: 0.75rem;
    }

    .chat-footer input {
        flex-grow: 1;
        padding: 0.875rem 1.25rem !important;
        border-radius: 99px !important;
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid var(--chat-border) !important;
        color: white !important;
        font-size: 0.95rem;
    }

    .msg-bubble {
        padding: 0.875rem 1.15rem !important;
        border-radius: 18px !important;
        max-width: 85% !important;
        font-size: 0.95rem !important;
        line-height: 1.5 !important;
        color: white !important;
    }

    .chat-msg.user {
        align-self: flex-end;
    }

    .chat-msg.user .msg-bubble {
        background: var(--chat-user-msg) !important;
    }

    .chat-msg.bot {
        align-self: flex-start;
    }

    .chat-msg.bot .msg-bubble {
        background: var(--chat-bot-msg) !important;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fab = document.getElementById('chat-fab');
        const widget = document.getElementById('chat-widget');
        const closeBtn = document.getElementById('close-chat');
        const form = document.getElementById('widget-form');
        const input = document.getElementById('widget-input');
        const history = document.getElementById('widget-history');

        // Detect Page Mode
        const isBookingPage = window.location.pathname.includes('/booking/');
        const currentMode = isBookingPage ? 'booking' : 'general';

        if (isBookingPage) {
            document.querySelector('.chat-header span:last-child').textContent = 'Booking Specialist';
            const welcomeMsg = document.querySelector('.chat-body .msg-bubble');
            if (welcomeMsg) {
                welcomeMsg.textContent = "Hello! I'm your Booking Specialist. Tell me which event you'd like to book, and I'll handle the rest for you.";
            }
        }

        // Toggle Widget
        function toggleWidget() {
            widget.classList.toggle('active');
            if (widget.classList.contains('active')) {
                input.focus();
            }
        }

        fab.addEventListener('click', toggleWidget);
        closeBtn.addEventListener('click', toggleWidget);

        // Send Message
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            // User UI
            appendMessage(message, 'user');
            input.value = '';

            // Loading UI
            const loadingId = appendMessage('...', 'bot', true);

            try {
                const formData = new FormData();
                formData.append('chat_message', message);
                formData.append('mode', currentMode); // Uses the page-aware mode
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Remove loading and show response
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                if (data.reply) {
                    appendMessage(data.reply, 'bot');
                }

                if (data.redirect) {
                    // If no reply was given, show a default message
                    if (!data.reply) {
                        appendMessage("Sure! taking you to the booking tab now...", 'bot');
                    }
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1500);
                }

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                appendMessage("Error connecting to AI.", 'bot');
            }
        });

        function appendMessage(text, sender, isLoading = false) {
            const div = document.createElement('div');
            div.className = `chat-msg ${sender} ${isLoading ? 'loading' : ''}`;
            if (isLoading) div.id = 'loading-' + Date.now();

            div.innerHTML = `
                <div class="msg-bubble">
                    ${text}
                </div>
            `;

            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }
    });
</script>